#!/usr/bin/env bash

set -eux

export OS="$(uname -s)"

if [ "${OS}" = "Darwin" ]; then
  export OS_EMOJI=':apple:'
else
  if [ "${OS}" = "Linux" ]; then
    export OS_EMOJI=':penguin:'
  else
    echo 'Unrecognized OS! Got "'"${OS}"'" but expected either "Darwin" or "Linux"'
    exit 1
  fi
fi

export COMMIT_PREFIX='`'"$(date '+%Y/%m/%d %H:%M:%S')"' `'"${OS_EMOJI}"

# Synchronize Logseq notes:
if [ "${1:+1}" ]; then :; else
  if [ -d ~/Desktop/logseq ]; then
    cd ~/Desktop/logseq
    git pull
    git submodule update --init --recursive --remote
    make .updated
    git add -A
    git commit -m "${COMMIT_PREFIX}" || :
    git push
  fi
fi

# Nav to the configuration directory:
if [ -d ~/.config/nix ]; then
  cd ~/.config/nix
else
  if [ -d /etc/nixos ]; then
    cd /etc/nixos
  else
    echo 'Neither ~/.config/nix nor /etc/nixos exist!'
    exit 1
  fi
fi

if [ "${1:+1}" ]; then :; else
  git pull
fi

nixfmt .

# Check if anything changed, and, if so, remove the success/failure flag:
if [ -z "$(git status --porcelain)" ]; then :; else
  rm -f .build-succeeded .build-failed
fi

# Push changes upstream with a W.I.P. note (wrench emoji):
if [ "${1:+1}" ]; then :; else
  if [ -f .build-succeeded ]; then :; else
    if [ -f .build-failed ]; then :; else
      git add -A
      git commit -m "${COMMIT_PREFIX}"'` `:wrench:` `'"${USER}" || :
      git push || :
    fi
  fi
fi

# Update dependencies:
nix flake update || : # rate limits!
if [ -z "$(git status --porcelain)" ]; then :; else
  if [ "${1:+1}" ]; then :; else
    git add -A
    git commit -m "${COMMIT_PREFIX}"'` `:arrow_up:` `'"${USER}" || :
    git push || :
  fi
fi

if [[ "${OS}" == "Linux" ]]; then
  cd /etc/nixos
  sudo git fetch
  sudo git reset --hard origin/main
  export CMD="sudo nixos-rebuild"
else
  if [[ "${OS}" == "Darwin" ]]; then
    export CMD="nix --extra-experimental-features flakes --extra-experimental-features nix-command run nix-darwin --"
    # export CMD="darwin-rebuild"
  else
    echo 'Unrecognized OS'
    exit 1
  fi
fi

# Rebuild the Nix system:
if
  ${CMD} switch --flake . --keep-going -v -j auto --show-trace # --install-bootloader
then
  cd ~/.config/nix
  touch .build-succeeded
  if [ "${1:+1}" ]; then :; else
    git add -A
    git commit -m "${COMMIT_PREFIX}"'` `:white_check_mark:` `'"${USER}" || :
    git push || :
  fi
  ( nix-collect-garbage -j auto --delete-old > /dev/null 2>&1 & )
else
  cd ~/.config/nix
  touch .build-failed
  if [ "${1:+1}" ]; then :; else
    git add -A
    git commit -m "${COMMIT_PREFIX}"'` `:fire:` `'"${USER}" || :
    git push || :
  fi
fi
